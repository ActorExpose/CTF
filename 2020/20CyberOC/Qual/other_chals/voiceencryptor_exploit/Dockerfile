FROM ubuntu:18.04

# Setup environ
ENV user encryptor
ENV prob_port 13101

# Install packages
RUN apt-get update -y
RUN apt-get install -y python-pip python-dev build-essential netcat

# Change permission
RUN chmod 1733 /tmp /var/tmp /dev/shm

# Additional configuration
RUN adduser $user
ADD ./app.py /home/$user/app.py
ADD ./mrswatson64 /home/$user/mrswatson64
ADD ./MyPlugin.so /home/$user/MyPlugin.so
ADD ./flag /home/$user/flag
ADD ./md5_rev_flag /home/$user/md5_rev_flag
ADD ./requirements.txt /home/$user/requirements.txt
ADD ./index.html /home/$user/index.html
ADD ./encrypt.sh /home/$user/encrypt.sh

RUN chown -R root:root /home/$user/
RUN chown root:$user /home/$user/app.py
RUN chown root:$user /home/$user/mrswatson64
RUN chown root:$user /home/$user/MyPlugin.so
RUN chown root:$user /home/$user/flag
RUN chown root:$user /home/$user/md5_rev_flag
RUN chown root:$user /home/$user/requirements.txt
RUN chown root:$user /home/$user/index.html
RUN chown root:$user /home/$user/encrypt.sh

RUN chmod 2755 /home/$user/app.py
RUN chmod 440 /home/$user/flag
RUN chmod 440 /home/$user/requirements.txt
RUN chmod 440 /home/$user/index.html
RUN chmod 755 /home/$user/mrswatson64
RUN chmod 755 /home/$user/MyPlugin.so
RUN chmod 440 /home/$user/md5_rev_flag
RUN chmod 755 /home/$user/encrypt.sh

# final
WORKDIR /home/$user
RUN pip install -r requirements.txt
CMD ["python", "app.py"]
USER $user
EXPOSE $prob_port
